# app_np.py
import streamlit as st
import pandas as pd
import altair as alt
import json
import np_constants as c
import np_data_manager as dm
import np_calculations as calc
from uaf_styles import load_css
from pathlib import Path
import base64
from datetime import datetime
import datetime as dt
from oauth_google import ensure_login, logout_button, _google_userinfo_via_button


# --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –ê–î–ú–Ü–ù–Ü–°–¢–†–ê–¢–û–†–Ü–í ---
# –í–ø–∏—à—ñ—Ç—å —Å—é–¥–∏ –ü–Ü–ë —Ç–∏—Ö, —Ö—Ç–æ –±—É–¥–µ –º–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞
ADMIN_USERS = ["–ü–∞–º–ø—É—Ö–∞ –Ü–≥–æ—Ä –í–æ–ª–æ–¥–∏–º–∏—Ä–æ–≤–∏—á", "–õ–æ–≥—É–Ω–æ–≤ –Ü–≥–æ—Ä –Æ—Ä—ñ–π–æ–≤–∏—á", "–ë—ñ–ª–∞–Ω –ú–∞–∫—Å–∏–º –ë–æ—Ä–∏—Å–æ–≤–∏—á",
               "–ö–∞—Ä–ø–µ–Ω–∫–æ –ê–Ω–¥—Ä—ñ–π –û–ª–µ–∫—Å—ñ–π–æ–≤–∏—á"]


# --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ---
st.set_page_config(layout="wide", page_title="–°–∏—Å—Ç–µ–º–∞ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è –ù–ü", page_icon="favicon.ico")

# üîΩ –î–æ–¥–∞—î–º–æ —É—Ç–∏–ª—ñ—Ç—É –¥–ª—è –ø—ñ–¥–º—ñ–Ω–∏ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
def with_pretty_headers(df: pd.DataFrame) -> pd.DataFrame:
    labels = getattr(c, "COLUMN_LABELS", {})
    return df.rename(columns=lambda col: labels.get(col, col))


def favicon_data_uri(path: str = "favicon.ico") -> str:
    p = Path(path)
    with p.open("rb") as f:
        b64 = base64.b64encode(f.read()).decode("ascii")
    # MIME –¥–ª—è .ico
    return f"data:image/x-icon;base64,{b64}"


def ui_bool(label: str, df: pd.DataFrame, row_idx, col_key: str, pib: str, period: str):
    """
    –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —á–µ–∫–±–æ–∫—Å –¥–ª—è –±—ñ–Ω–∞—Ä–Ω–∏—Ö –ø–æ–ª—ñ–≤.
    - –ì–ª–æ–±–∞–ª—å–Ω–æ-—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π key (—â–æ–± –Ω–µ –∑–ª–∏–ø–∞–≤—Å—è —Å—Ç–∞–Ω).
    - –ñ–æ—Ä—Å—Ç–∫–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—è –¥–æ bool –Ω–∞ –≤—Ö–æ–¥—ñ, —ñ –∑–∞–ø–∏—Å 0/1 –Ω–∞ –≤–∏—Ö–æ–¥—ñ.
    """
    st_key = f"chk::{col_key}::{pib}::{period}"

    # –ø–æ—Ç–æ—á–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ DF ‚Üí —É —á–∏—Å—Ç–∏–π bool
    raw = df.at[row_idx, col_key] if col_key in df.columns else 0
    try:
        base_bool = bool(int(raw)) if pd.notna(raw) else False
    except Exception:
        base_bool = False  # –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫

    checked = st.checkbox(label, value=base_bool, key=st_key)
    df.at[row_idx, col_key] = 1 if checked else 0
    return checked

def ui_bool_form(col_key: str, label: str) -> bool:
    """
    –ß–µ–∫–±–æ–∫—Å –¥–ª—è —Ñ–æ—Ä–º –≤–≤–µ–¥–µ–Ω–Ω—è (–ø—Ä–∞—Ü—é—î –∑ st.session_state.np_form_data).
    - –ì–ª–æ–±–∞–ª—å–Ω–æ-—É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –Ω–∞ –æ—Å–Ω–æ–≤—ñ (col_key, –ü–Ü–ë, –ø–µ—Ä—ñ–æ–¥).
    - –ñ–æ—Ä—Å—Ç–∫–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ bool, –∑–±–µ—Ä—ñ–≥–∞—î 0/1 —É np_form_data.
    """
    import math

    form_data = st.session_state.np_form_data

    pib = str(form_data.get(c.COL_PIB, st.session_state.get("selected_pib", "")))
    period = str(form_data.get(c.NP_COL_PERIOD, st.session_state.get("selected_period", "")))
    st_key = f"chk::{col_key}::{pib}::{period}"

    raw = form_data.get(col_key, 0)

    # -> —á–∏—Å—Ç–∏–π bool
    base = False
    try:
        if raw is None:
            base = False
        elif isinstance(raw, bool):
            base = raw
        elif isinstance(raw, (int, float)):
            base = (not (isinstance(raw, float) and math.isnan(raw))) and (int(raw) != 0)
        else:
            s = str(raw).strip().lower()
            base = s in ("1", "true", "—Ç–∞–∫", "yes", "y", "on")
    except Exception:
        base = False

    checked = st.checkbox(label, value=base, key=st_key)
    form_data[col_key] = 1 if checked else 0
    return checked

def _form_keys_suffix():
    fd = st.session_state.np_form_data
    pib = str(fd.get(c.COL_PIB, st.session_state.get("selected_pib", "")))
    period = str(fd.get(c.NP_COL_PERIOD, st.session_state.get("selected_period", "")))
    return pib, period

def ui_int_form(col_key: str, label: str, min_value: int = 0, step: int = 1) -> int:
    """number_input –¥–ª—è —Ü—ñ–ª–∏—Ö —É —Ñ–æ—Ä–º—ñ"""
    import math
    fd = st.session_state.np_form_data
    pib, period = _form_keys_suffix()
    st_key = f"num::{col_key}::{pib}::{period}"
    raw = fd.get(col_key, 0)
    try:
        val = 0 if raw is None or (isinstance(raw, float) and math.isnan(raw)) else int(raw)
    except Exception:
        val = 0
    out = st.number_input(label, value=val, min_value=min_value, step=step, key=st_key)
    fd[col_key] = int(out)
    return int(out)

def ui_float_form(col_key: str, label: str, min_value: float = 0.0, step: float = 0.1) -> float:
    """number_input –¥–ª—è float —É —Ñ–æ—Ä–º—ñ (–Ω–∞–ø—Ä., —ñ–Ω–¥–µ–∫—Å –ì—ñ—Ä—à–∞)"""
    import math
    fd = st.session_state.np_form_data
    pib, period = _form_keys_suffix()
    st_key = f"numf::{col_key}::{pib}::{period}"
    raw = fd.get(col_key, 0.0)
    try:
        val = 0.0 if raw is None or (isinstance(raw, float) and math.isnan(raw)) else float(raw)
    except Exception:
        val = 0.0
    out = st.number_input(label, value=val, min_value=min_value, step=step, key=st_key, format="%.2f")
    fd[col_key] = float(out)
    return float(out)

def ui_json_form(col_key: str, label: str, hint: str = "[]", height: int = 120) -> str:
    """text_area –¥–ª—è JSON-–¥–µ—Ç–∞–ª–µ–π (—Å—Ç–∞—Ç—Ç—ñ/–¥–æ–ø–æ–≤—ñ–¥—ñ/–º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—ó/—Ä–µ–¥–∫–æ–ª–µ–≥—ñ—ó —Ç–æ—â–æ) –∑ –ª–µ–≥–∫–æ—é –≤–∞–ª—ñ–¥–∞—Ü—ñ—î—é"""
    import json
    fd = st.session_state.np_form_data
    pib, period = _form_keys_suffix()
    st_key = f"json::{col_key}::{pib}::{period}"
    val = fd.get(col_key, "[]")
    if not isinstance(val, str):
        try:
            val = json.dumps(val, ensure_ascii=False)
        except Exception:
            val = "[]"
    txt = st.text_area(label, value=val, key=st_key, height=height, placeholder=hint)
    # –º‚Äô—è–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
    try:
        parsed = json.loads((txt or "").strip() or "[]")
        ok = isinstance(parsed, (list, dict))
    except Exception:
        ok = False
    if ok:
        fd[col_key] = txt.strip()
        st.caption("‚úÖ JSON –≤–∞–ª—ñ–¥–Ω–∏–π")
    else:
        st.caption("‚ö†Ô∏è –û—á—ñ–∫—É—î—Ç—å—Å—è JSON (—Å–ø–∏—Å–æ–∫ –∞–±–æ –æ–±‚Äô—î–∫—Ç). –ù–∞–ø—Ä.: [ {\"type\":\"–§–∞—Ö–æ–≤—ñ –£–∫—Ä–∞—ó–Ω–∏\",\"count\":2} ]")
    return txt

def ui_text_form(col_key: str, label: str, placeholder: str = "", max_chars: int = 300) -> str:
    """text_input –¥–ª—è —Ñ–æ—Ä–º (—Ä—è–¥–∫–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è), —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π key = col_key+pib+period"""
    fd = st.session_state.np_form_data
    pib = str(fd.get(c.COL_PIB, st.session_state.get("selected_pib", "")))
    period = str(fd.get(c.NP_COL_PERIOD, st.session_state.get("selected_period", "")))
    st_key = f"txt::{col_key}::{pib}::{period}"
    val = fd.get(col_key, "")
    out = st.text_input(label, value=str(val) if val is not None else "", key=st_key, placeholder=placeholder, max_chars=max_chars)
    fd[col_key] = out.strip()
    return fd[col_key]

def humanize_bools(df: pd.DataFrame) -> pd.DataFrame:
    """–ó–∞–º—ñ–Ω—é—î boolean-ish –∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ '–¢–∞–∫'/'–ù—ñ' –ª–∏—à–µ –≤ —Ç–∏—Ö —Å—Ç–æ–≤–ø—Ü—è—Ö, –¥–µ —Ü–µ —Å–ø—Ä–∞–≤–¥—ñ –±—É–ª—ñ."""
    df_copy = df.copy()

    def is_booleanish(series: pd.Series) -> bool:
        # –ø—Ä–∏–≤–æ–¥–∏–º–æ –≤—Å–µ –¥–æ –Ω–∏–∂–Ω—å–æ–≥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É —Ä—è–¥–∫–æ–º —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        vals = series.dropna().astype(str).str.strip().str.lower().unique()
        # –ø–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–æ–≤–ø–µ—Ü—å –Ω–µ —á—ñ–ø–∞—î–º–æ
        if len(vals) == 0:
            return False
        # –±—É–ª–µ–≤–∏–π —Ç–∏–ø –æ–¥—Ä–∞–∑—É –û–ö
        if series.dtype == bool:
            return True
        # —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≤—Å—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –Ω–∞–±–æ—Ä—É true/false/1/0
        return set(vals).issubset({"true", "false", "1", "0"})

    def map_boolish(x):
        if isinstance(x, bool):
            return "–¢–∞–∫" if x else "–ù—ñ"
        if x is None or (isinstance(x, float) and pd.isna(x)):
            return x
        s = str(x).strip().lower()
        if s in ("true", "1"):
            return "–¢–∞–∫"
        if s in ("false", "0"):
            return "–ù—ñ"
        return x

    for col in df_copy.columns:
        if is_booleanish(df_copy[col]):
            df_copy[col] = df_copy[col].map(map_boolish)

    return df_copy

# --- CSS –°–¢–ò–õ–Ü–ó–ê–¶–Ü–Ø –ó–ê –ë–†–ï–ù–î–ë–£–ö–û–ú –ó–°–£ ---

load_css()

# --- –ö–Ü–ù–ï–¶–¨ –ë–õ–û–ö–£ –°–¢–ò–õ–Ü–í ---

# --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---
if 'np_structure' not in st.session_state:
    st.session_state.np_structure = dm.load_np_structure()
if 'np_ratings' not in st.session_state:
    st.session_state.np_ratings = dm.initialize_np_ratings_df(st.session_state.np_structure)

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É –≤—Ö–æ–¥—É
if 'logged_in_user' not in st.session_state:
    st.session_state.logged_in_user = None
if 'is_admin' not in st.session_state:
    st.session_state.is_admin = False

# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ç–∞–Ω—É —Ñ–æ—Ä–º–∏
if 'current_np_pib' not in st.session_state:
    st.session_state.current_np_pib = None
if 'np_form_data' not in st.session_state:
    st.session_state.np_form_data = {}
# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è JSON –ø–æ–ª—ñ–≤
if 'np_ntr_articles_list' not in st.session_state: st.session_state.np_ntr_articles_list = []
if 'np_ntr_reports_list' not in st.session_state: st.session_state.np_ntr_reports_list = []
if 'np_ntr_mono_solo_list' not in st.session_state: st.session_state.np_ntr_mono_solo_list = []
if 'np_ntr_mono_team_list' not in st.session_state: st.session_state.np_ntr_mono_team_list = []
if 'np_ntr_review_articles_list' not in st.session_state: st.session_state.np_ntr_review_articles_list = []
if 'np_or_conferences_list' not in st.session_state: st.session_state.np_or_conferences_list = []
if 'np_or_olympiads_list' not in st.session_state: st.session_state.np_or_olympiads_list = []
if 'np_or_editorial_list' not in st.session_state: st.session_state.np_or_editorial_list = []


# --- –§—É–Ω–∫—Ü—ñ—ó –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
def get_current_np_data_row(pib):
    """–û—Ç—Ä–∏–º—É—î –ø–æ—Ç–æ—á–Ω–∏–π —Ä—è–¥–æ–∫ –¥–∞–Ω–∏—Ö –¥–ª—è –ù–ü —Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î session_state –¥–ª—è —Ñ–æ—Ä–º–∏."""
    if pib and not st.session_state.np_ratings.empty and pib in st.session_state.np_ratings[c.COL_PIB].values:
        np_data_row = st.session_state.np_ratings[st.session_state.np_ratings[c.COL_PIB] == pib].iloc[0].copy()
        st.session_state.np_form_data = np_data_row.to_dict()
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON –ø–æ–ª—ñ–≤
        st.session_state.np_ntr_articles_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_NTR_STATTI_DETAILS_JSON, '[]'))
        st.session_state.np_ntr_reports_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_NTR_DOPOVIDI_DETAILS_JSON, '[]'))
        st.session_state.np_ntr_mono_solo_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_NTR_MONO_ODNOOSIBNA_DETAILS_JSON, '[]'))
        st.session_state.np_ntr_mono_team_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_NTR_MONO_KOLEKTYVNA_DETAILS_JSON, '[]'))
        st.session_state.np_ntr_review_articles_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_NTR_RECENZ_STATTI_DETAILS_JSON, '[]'))
        st.session_state.np_or_conferences_list = calc.parse_json_details(
            st.session_state.np_form_data.get(c.NP_COL_OR_KONFERENTSII_DETAILS_JSON, '[]'))
    elif pib != st.session_state.current_np_pib:
        st.session_state.np_form_data = {}
        st.session_state.np_ntr_articles_list = []
        st.session_state.np_ntr_reports_list = []
        st.session_state.np_ntr_mono_solo_list = []
        st.session_state.np_ntr_mono_team_list = []
        st.session_state.np_ntr_review_articles_list = []
        st.session_state.np_or_conferences_list = []
    st.session_state.current_np_pib = pib


# --- –§—É–Ω–∫—Ü—ñ—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó ---
def display_scores_summary(pib):
    """–í—ñ–¥–æ–±—Ä–∞–∂–∞—î –¥—ñ–∞–≥—Ä–∞–º—É –∑ –ø–æ—Ç–æ—á–Ω–∏–º–∏ –±–∞–ª–∞–º–∏ —Ç–∞ –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è–º –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –ù–ü."""
    if pib and not st.session_state.np_ratings.empty and pib in st.session_state.np_ratings[c.COL_PIB].values:
        # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        scores = st.session_state.np_ratings[st.session_state.np_ratings[c.COL_PIB] == pib].iloc[0]
        chart_data = {
            "–ü–æ—Å—Ç—ñ–π–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ (–ü–ü)": scores.get(c.NP_COL_PP_TOTAL, 0),
            "–ù–∞—É–∫–æ–≤–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å (–ù–¢–†)": scores.get(c.NP_COL_NTR_TOTAL, 0),
            "–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å (–û–†)": scores.get(c.NP_COL_OR_TOTAL, 0),
        }
        total_score = scores.get(c.NP_COL_IB_TOTAL, 0)

        # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å–µ—Ä–µ–¥–Ω—ñ—Ö –±–∞–ª—ñ–≤ –ø–æ –≤—Å—ñ–º –ù–ü –¥–ª—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è
        avg_scores = st.session_state.np_ratings[[c.NP_COL_PP_TOTAL, c.NP_COL_NTR_TOTAL, c.NP_COL_OR_TOTAL]].mean().to_dict()

        # –ü–æ—î–¥–Ω—É—î–º–æ –¥–∞–Ω—ñ –≤ DataFrame
        df_chart = pd.DataFrame({
            "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è": list(chart_data.keys()),
            "–í–∞—à—ñ –±–∞–ª–∏": list(chart_data.values()),
            "–°–µ—Ä–µ–¥–Ω—ñ –±–∞–ª–∏": [avg_scores.get(col, 0) for col in chart_data.keys()]
        })

        # –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ Altair
        base = alt.Chart(df_chart).encode(
            x=alt.X("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:N", axis=alt.Axis(labelAngle=0)),
            tooltip=["–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", alt.Tooltip("–í–∞—à—ñ –±–∞–ª–∏:Q", format=".2f"), alt.Tooltip("–°–µ—Ä–µ–¥–Ω—ñ –±–∞–ª–∏:Q", format=".2f")]
        ).properties(height=300, width=300)

        bars = base.mark_bar(opacity=0.7).encode(
            y=alt.Y("–í–∞—à—ñ –±–∞–ª–∏:Q", title="–ë–∞–ª–∏"),
            color=alt.value("#FFD700")  # –ó–æ–ª–æ—Ç–∏–π –∫–æ–ª—ñ—Ä
        )

        avg_line = base.mark_rule(color="#808080").encode(
            y="–°–µ—Ä–µ–¥–Ω—ñ –±–∞–ª–∏:Q",
            size=alt.value(2)
        )

        chart = (bars + avg_line).interactive()

        st.subheader(f"–ü–æ—Ç–æ—á–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {total_score:.2f} –±–∞–ª—ñ–≤")
        st.altair_chart(chart, use_container_width=True)

        # –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —ñ–Ω—Å–∞–π—Ç
        st.text(f"–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è: –í–∏ –ø–µ—Ä–µ–≤–∏—â—É—î—Ç–µ —Å–µ—Ä–µ–¥–Ω—ñ–π –±–∞–ª —É {sum(1 for v, a in zip(chart_data.values(), avg_scores.values()) if v > a)} —ñ–∑ 3 –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.")


# --- UI –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ñ–æ—Ä–º ---
def render_np_pp_form():
    with st.expander("–î–æ–¥–∞—Ç–æ–∫ 1.2: –ü–æ—Å—Ç—ñ–π–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ (–ü–ü)", expanded=False):
        # --- –ü–∞—Ä–∞ 1 & 2 ---
        col1, col2 = st.columns(2, border=True)

        with col1:
            st.subheader("üéì 1. –ù–∞—É–∫–æ–≤–∏–π —Å—Ç—É–ø—ñ–Ω—å")
            st.markdown("---")

            st.session_state.np_form_data[c.NP_COL_PP_KVAL_KANDYDAT] = ui_bool_form(
                c.NP_COL_PP_KVAL_KANDYDAT,
                "–î–∏–ø–ª–æ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–∞—É–∫ (–¥–æ–∫—Ç–æ—Ä–∞ —Ñ—ñ–ª–æ—Å–æ—Ñ—ñ—ó)"
            )

            st.session_state.np_form_data[c.NP_COL_PP_KVAL_PHD_ABROAD] = ui_bool_form(
                c.NP_COL_PP_KVAL_PHD_ABROAD,
                "–ó–∞–∫–æ—Ä–¥–æ–Ω–Ω–∏–π –¥–∏–ø–ª–æ–º PhD"
            )

            st.session_state.np_form_data[c.NP_COL_PP_KVAL_DOCTOR] = ui_bool_form(
                c.NP_COL_PP_KVAL_DOCTOR,
                "–î–∏–ø–ª–æ–º –¥–æ–∫—Ç–æ—Ä–∞ –Ω–∞—É–∫"
            )


        with col2:
            st.subheader("üë®üèΩ‚Äçüéì 2. –í—á–µ–Ω–µ –∑–≤–∞–Ω–Ω—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_VZVAN_STARSH_DOSL] = ui_bool_form(
                c.NP_COL_PP_VZVAN_STARSH_DOSL,
                "–°—Ç–∞—Ä—à–∏–π –¥–æ—Å–ª—ñ–¥–Ω–∏–∫ (–°–ù–°)",
                )
            st.session_state.np_form_data[c.NP_COL_PP_VZVAN_DOTSENT] = ui_bool_form(
                c.NP_COL_PP_VZVAN_DOTSENT,
                "–î–æ—Ü–µ–Ω—Ç",
                )
            st.session_state.np_form_data[c.NP_COL_PP_VZVAN_PROFESOR] = ui_bool_form(
                c.NP_COL_PP_VZVAN_PROFESOR,
                "–ü—Ä–æ—Ñ–µ—Å–æ—Ä",
                )
        st.markdown("---")

        # --- –ü–∞—Ä–∞ 3 & 4 ---

        col1, col2 = st.columns(2, border=True)
        with col1:

            st.subheader("üèÖ 3. –î–µ—Ä–∂–∞–≤–Ω–∞ –ø—Ä–µ–º—ñ—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_DERZH_PREMIYA] = ui_bool_form(
                c.NP_COL_PP_DERZH_PREMIYA,
                "–õ–∞—É—Ä–µ–∞—Ç –î–µ—Ä–∂–∞–≤–Ω–æ—ó –ø—Ä–µ–º—ñ—ó"
                )

        with col2:

            st.subheader("üéñÔ∏è 4. –ü–æ—á–µ—Å–Ω–µ –∑–≤–∞–Ω–Ω—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_POCHESNE_ZVANNYA] = ui_bool_form(
                c.NP_COL_PP_POCHESNE_ZVANNYA,
                "–ù–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ—á–µ—Å–Ω–æ–≥–æ –∑–≤–∞–Ω–Ω—è (–ó–∞—Å–ª—É–∂–µ–Ω–∏–π –¥—ñ—è—á, –≤–∏–Ω–∞—Ö—ñ–¥–Ω–∏–∫, —é—Ä–∏—Å—Ç —Ç–æ—â–æ)")

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 5 & 6 ---

        col1, col2 = st.columns(2, border=True)
        with col1:

            st.subheader("üèÜ 5. –ù–∞–≥–æ—Ä–æ–¥–∏")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_NAGORODY_VRU_KMU] = ui_bool_form(
                c.NP_COL_PP_NAGORODY_VRU_KMU, "–ì—Ä–∞–º–æ—Ç–∞ –í–†–£ / –ö–ú–£")
            st.session_state.np_form_data[c.NP_COL_PP_NAGORODY_ORDER] = ui_bool_form(
                c.NP_COL_PP_NAGORODY_ORDER, "–û—Ä–¥–µ–Ω (–¥–µ—Ä–∂–∞–≤–Ω–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞)")
            st.session_state.np_form_data[c.NP_COL_PP_NAGORODY_VIDOVI] = ui_bool_form(
                c.NP_COL_PP_NAGORODY_VIDOVI, "–ó–∞–æ—Ö–æ—á–µ–Ω–Ω—è –≤—ñ–¥ –∫–æ–º–∞–Ω–¥—É–≤–∞—á—ñ–≤ –≤–∏–¥—ñ–≤, —Ä–æ–¥—ñ–≤ –≤—ñ–π—Å—å–∫ (—Å–∏–ª)")
            st.session_state.np_form_data[c.NP_COL_PP_NAGORODY_VIKNU] = ui_bool_form(
                c.NP_COL_PP_NAGORODY_VIKNU, "–ó–∞–æ—Ö–æ—á–µ–Ω–Ω—è –≤—ñ–¥ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –í—ñ–π—Å—å–∫–æ–≤–æ–≥–æ —ñ–Ω—Å—Ç–∏—Ç—É—Ç—É")

        with col2:

            st.subheader("üèõÔ∏è 6. –ß–ª–µ–Ω—Å—Ç–≤–æ –≤ –∞–∫–∞–¥–µ–º—ñ—è—Ö –Ω–∞—É–∫")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_NAN_CHLEN] = ui_bool_form(
                c.NP_COL_PP_NAN_CHLEN, "–î—ñ–π—Å–Ω–∏–π —á–ª–µ–Ω –ù–ê–ù–£")
            st.session_state.np_form_data[c.NP_COL_PP_NAN_CHLEN_KOR] = ui_bool_form(
                c.NP_COL_PP_NAN_CHLEN_KOR, "–ß–ª–µ–Ω-–∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç –ù–ê–ù–£")
            st.session_state.np_form_data[c.NP_COL_PP_NAN_HALUZEVI_AKADEMIYI] = ui_bool_form(c.NP_COL_PP_NAN_HALUZEVI_AKADEMIYI,
                "–ß–ª–µ–Ω –≥–∞–ª—É–∑–µ–≤–æ—ó –∞–∫–∞–¥–µ–º—ñ—ó –Ω–∞—É–∫")
            st.session_state.np_form_data[c.NP_COL_PP_NAN_HROMADSKI] = ui_bool_form(c.NP_COL_PP_NAN_HROMADSKI,
                "–ß–ª–µ–Ω –Ω–∞—É–∫–æ–≤–æ—ó –≥—Ä–æ–º–∞–¥—Å—å–∫–æ—ó –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó")
        st.markdown("---")

        # --- –ü–∞—Ä–∞ 7 & 8 ---

        col1, col2 = st.columns(2, border=True)
        with col1:

            st.subheader("üõ°Ô∏è 7. –°—Ç–∞—Ç—É—Å –£–ë–î")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_STATUS_UBD] = ui_bool_form(c.NP_COL_PP_STATUS_UBD,
                "–ù–∞—è–≤–Ω—ñ—Å—Ç—å —Å—Ç–∞—Ç—É—Å—É —É—á–∞—Å–Ω–∏–∫–∞ –±–æ–π–æ–≤–∏—Ö –¥—ñ–π")

        with col2:

            st.subheader("üåê 8. –£—á–∞—Å—Ç—å —É –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö –≤—ñ–π—Å—å–∫–æ–≤–∏—Ö –Ω–∞–≤—á–∞–Ω–Ω—è—Ö –ù–ê–¢–û")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_NAVCHANNYA_NATO_KILKIST] = ui_int_form(
                c.NP_COL_PP_NAVCHANNYA_NATO_KILKIST,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞–≤—á–∞–Ω—å",
                min_value=0,
                step=1
            )
        st.markdown("---")

        # --- –ü–∞—Ä–∞ 9 & 10 ---

        col1, col2 = st.columns(2, border=True)
        with col1:

            st.subheader("üë®‚Äçüíª 9. –ß–ª–µ–Ω –≤–æ—î–Ω–Ω–æ-–Ω–∞—É–∫–æ–≤–æ—ó –≥—Ä—É–ø–∏ –Ω–∞ –û–ö–ü –±—Ä–∏–≥–∞–¥–∏")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_PP_VNG_OKP_DNIV] = ui_int_form(
                c.NP_COL_PP_VNG_OKP_DNIV,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤ —É —Å–∫–ª–∞–¥—ñ –í–ù–ì",
                min_value=0, step=1
            )


        with col2:

            st.subheader("üó£Ô∏è 10. –†—ñ–≤–µ–Ω—å –≤–æ–ª–æ–¥—ñ–Ω–Ω—è —ñ–Ω–æ–∑–µ–º–Ω–æ—é –º–æ–≤–æ—é")
            st.markdown("---")
            lang_levels = list(c.NP_POINTS_PP_INOZEMNA_MOVA.keys())
            current_level = st.session_state.np_form_data.get(
                c.NP_COL_PP_INOZEMNA_MOVA_RIVEN,
                lang_levels[0] if lang_levels else "–ù–µ–º–∞—î"
            )
            st.session_state.np_form_data[c.NP_COL_PP_INOZEMNA_MOVA_RIVEN] = st.selectbox(
                "–†—ñ–≤–µ–Ω—å –°–ú–ü (CEFR)",
                options=lang_levels,
                index=lang_levels.index(current_level) if current_level in lang_levels else 0
            )

def render_np_ntr_form():
    with st.expander("–î–æ–¥–∞—Ç–æ–∫ 1.3: –ù–∞—É–∫–æ–≤–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å (–ù–¢–†)", expanded=False):

        # --- –ü–∞—Ä–∞ 1 & 2 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üéì 1. –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ç–∞ –∑–∞—Ö–∏—Å—Ç")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_ZAHYST_DOCTORSKA] = ui_bool_form(
                c.NP_COL_NTR_ZAHYST_DOCTORSKA, "–ó–∞—Ö–∏—Å—Ç –¥–æ–∫—Ç–æ—Ä—Å—å–∫–æ—ó –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ—ó"
            )
            st.session_state.np_form_data[c.NP_COL_NTR_ZAHYST_PHD] = ui_bool_form(
                c.NP_COL_NTR_ZAHYST_PHD, "–ó–∞—Ö–∏—Å—Ç –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ—ó –¥–æ–∫—Ç–æ—Ä–∞ —Ñ—ñ–ª–æ—Å–æ—Ñ—ñ—ó"
            )

        with col2:
            st.subheader("üßë‚Äçüè´ 2. –ù–∞—É–∫–æ–≤–µ –∫–æ–Ω—Å—É–ª—å—Ç—É–≤–∞–Ω–Ω—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_NAUK_KONSULT_ADYUNKT_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NAUK_KONSULT_ADYUNKT_KILKIST, "–ö-—Å—Ç—å –∞–¥‚Äô—é–Ω–∫—Ç—ñ–≤ (–∞—Å–ø—ñ—Ä–∞–Ω—Ç—ñ–≤)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_NAUK_KONSULT_DOCTORANT_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NAUK_KONSULT_DOCTORANT_KILKIST, "–ö-—Å—Ç—å –¥–æ–∫—Ç–æ—Ä–∞–Ω—Ç—ñ–≤", min_value=0, step=1
            )

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 3 & 4 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üßê 3. –û–ø–æ–Ω—É–≤–∞–Ω–Ω—è –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ–π")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_OPONUVANNYA_DOCTOR_NAUK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_OPONUVANNYA_DOCTOR_NAUK_KILKIST, "–ö-—Å—Ç—å –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ–π –¥–æ–∫—Ç–æ—Ä–∞ –Ω–∞—É–∫", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_OPONUVANNYA_PHD_KILKIST] = ui_int_form(
                c.NP_COL_NTR_OPONUVANNYA_PHD_KILKIST, "–ö-—Å—Ç—å –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ–π –¥–æ–∫—Ç–æ—Ä–∞ —Ñ—ñ–ª–æ—Å–æ—Ñ—ñ—ó", min_value=0, step=1
            )

        with col2:
            st.subheader("‚úçÔ∏è 4. –†–µ—Ü–µ–Ω–∑—É–≤–∞–Ω–Ω—è –¥–∏—Å–µ—Ä—Ç–∞—Ü—ñ–π")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_RECENZ_DYSERT_DOCTOR_NAUK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_RECENZ_DYSERT_DOCTOR_NAUK_KILKIST, "–ö-—Å—Ç—å —Ä–µ—Ü–µ–Ω–∑—ñ–π –Ω–∞ –¥–∏—Å. –¥–æ–∫—Ç–æ—Ä–∞ –Ω–∞—É–∫",
                min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_RECENZ_DYSERT_PHD_KILKIST] = ui_int_form(
                c.NP_COL_NTR_RECENZ_DYSERT_PHD_KILKIST, "–ö-—Å—Ç—å —Ä–µ—Ü–µ–Ω–∑—ñ–π –Ω–∞ –¥–∏—Å. PhD", min_value=0, step=1
            )

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 5 & 6 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("‚úÖ 5. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞–∫—Ç—É –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_AKTU_VPROVADZH_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_AKTU_VPROVADZH_KILKIST, "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç—ñ–≤ (–≥–æ–ª–æ–≤–∞ –∫–æ–º—ñ—Å—ñ—ó)", min_value=0, step=1
            )

        with col2:
            st.subheader("üî¨ 6. –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ù–î–†")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_NDR_DERZH_KERIVNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NDR_DERZH_KERIVNYK_KILKIST, "–ù–î–† –¥–µ—Ä–∂. (–∫–µ—Ä—ñ–≤–Ω–∏–∫)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_NDR_DERZH_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NDR_DERZH_VYKONAVETS_KILKIST, "–ù–î–† –¥–µ—Ä–∂. (–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_NDR_MIZHNAR_KERIVNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NDR_MIZHNAR_KERIVNYK_KILKIST, "–ù–î–† –º—ñ–∂–Ω–∞—Ä. (–∫–µ—Ä—ñ–≤–Ω–∏–∫)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_NDR_MIZHNAR_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_NDR_MIZHNAR_VYKONAVETS_KILKIST, "–ù–î–† –º—ñ–∂–Ω–∞—Ä. (–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å)", min_value=0, step=1
            )

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 7 & 8 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üìù 7. –í–∏–∫–æ–Ω–∞–Ω–Ω—è –û–ó / –†–æ–∑—Ä–æ–±–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_OZ_VIDPOV_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_OZ_VIDPOV_VYKONAVETS_KILKIST, "–û–ó (–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π –≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_OZ_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_OZ_VYKONAVETS_KILKIST, "–û–ó (–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_STANDART_KERIVNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_STANDART_KERIVNYK_KILKIST, "–°—Ç–∞–Ω–¥–∞—Ä—Ç (–∫–µ—Ä—ñ–≤–Ω–∏–∫)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_STANDART_VIDPOV_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_STANDART_VIDPOV_VYKONAVETS_KILKIST, "–°—Ç–∞–Ω–¥–∞—Ä—Ç (–≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π)", min_value=0, step=1
            )
            st.session_state.np_form_data[c.NP_COL_NTR_STANDART_VYKONAVETS_KILKIST] = ui_int_form(
                c.NP_COL_NTR_STANDART_VYKONAVETS_KILKIST, "–°—Ç–∞–Ω–¥–∞—Ä—Ç (–≤–∏–∫–æ–Ω–∞–≤–µ—Ü—å)", min_value=0, step=1
            )
        with col2:
            st.subheader("üìÑ 8. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–∞ –≤–∏–¥–∞–Ω–Ω—è –Ω–∞—É–∫–æ–≤–æ—ó —Å—Ç–∞—Ç—Ç—ñ")
            st.markdown("---")
            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            article_type_options = [NEUTRAL_LABEL, "Scopus Q1", "Scopus Q2", "Scopus Q3", "Scopus Q4",
                                    "–Ü–Ω—à—ñ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ –±–∞–∑–∏ (–∑–∞–∫–æ—Ä–¥–æ–Ω–Ω—ñ)", "–Ü–Ω—à—ñ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω—ñ –±–∞–∑–∏ (–≤—ñ—Ç—á–∏–∑–Ω—è–Ω—ñ)",
                                    "–ó–∞–∫–æ—Ä–¥–æ–Ω–Ω—ñ (–Ω–µ—ñ–Ω–¥–µ–∫—Å–æ–≤–∞–Ω—ñ)", "–§–∞—Ö–æ–≤—ñ –£–∫—Ä–∞—ó–Ω–∏", "–ù–µ—Ñ–∞—Ö–æ–≤—ñ –£–∫—Ä–∞—ó–Ω–∏"]

            cols = st.columns([3, 1])
            new_article_type = cols[0].selectbox("–¢–∏–ø —Å—Ç–∞—Ç—Ç—ñ", options=article_type_options,
                                                 key="np_new_article_type")
            new_article_count = cols[1].number_input("–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1,
                                                     key="np_new_article_count")
            if st.button("–î–æ–¥–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—ñ", key="np_add_article"):
                if new_article_type != NEUTRAL_LABEL:
                    st.session_state.np_ntr_articles_list.append(
                        {"type": new_article_type, "count": new_article_count})
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø —Å—Ç–∞—Ç—Ç—ñ –ø–µ—Ä—à –Ω—ñ–∂ –¥–æ—Ç–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é")
            if st.session_state.np_ntr_articles_list:
                st.write("–î–æ–¥–∞–Ω—ñ —Å—Ç–∞—Ç—Ç—ñ:")
                for i, article in enumerate(st.session_state.np_ntr_articles_list):
                    cols = st.columns([3, 1, 1])
                    cols[0].write(f"**–¢–∏–ø:** {article['type']}")
                    cols[1].write(f"**–ö-—Å—Ç—å:** {article['count']}")
                    if cols[2].button("üóëÔ∏è", key=f"np_del_article_{i}"):
                        st.session_state.np_ntr_articles_list.pop(i)
                        st.rerun()

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 9 & 10 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üé§ 9. –î–æ–ø–æ–≤—ñ–¥—ñ –Ω–∞ –Ω–∞—É–∫–æ–≤–∏—Ö –∑–∞—Ö–æ–¥–∞—Ö")
            st.markdown("---")
            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            report_type_options = [NEUTRAL_LABEL, "–¢–µ–∑–∏ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ–π", "–¢–µ–∑–∏ –≤—Å–µ—É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ–π",
                                   "–¢–µ–∑–∏ –º—ñ–∂–≤—É–∑—ñ–≤—Å—å–∫–∏—Ö (–≤—É–∑—ñ–≤—Å—å–∫–∏—Ö) –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ–π"]

            cols_rep = st.columns([3, 1])
            new_report_type = cols_rep[0].selectbox("–¢–∏–ø –¥–æ–ø–æ–≤—ñ–¥—ñ", options=report_type_options,
                                                    key="np_new_report_type")
            new_report_count = cols_rep[1].number_input("–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1,
                                                        key="np_new_report_count")
            if st.button("–î–æ–¥–∞—Ç–∏ –¥–æ–ø–æ–≤—ñ–¥—å", key="np_add_report"):
                if new_report_type != NEUTRAL_LABEL:
                    st.session_state.np_ntr_reports_list.append(
                        {"type": new_report_type, "count": new_report_count})
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –¥–æ–ø–æ–≤—ñ–¥—ñ –ø–µ—Ä—à –Ω—ñ–∂ –¥–æ–¥–∞—Ç–∏ –¥–æ–ø–æ–≤—ñ–¥—å")
            if st.session_state.np_ntr_reports_list:
                st.write("–î–æ–¥–∞–Ω—ñ –¥–æ–ø–æ–≤—ñ–¥—ñ:")
                for i, report in enumerate(st.session_state.np_ntr_reports_list):
                    cols_rep_disp = st.columns([3, 1, 1])
                    cols_rep_disp[0].write(f"**–¢–∏–ø:** {report['type']}")
                    cols_rep_disp[1].write(f"**–ö-—Å—Ç—å:** {report['count']}")
                    if cols_rep_disp[2].button("üóëÔ∏è", key=f"np_del_report_{i}"):
                        st.session_state.np_ntr_reports_list.pop(i)
                        st.rerun()
        with col2:
            st.subheader("üí° 10. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–∞—Ç–µ–Ω—Ç—É / –º–æ–¥–µ–ª—ñ")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PATENT_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PATENT_KILKIST, "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Ç–µ–Ω—Ç—ñ–≤", min_value=0, step=1)

            st.session_state.np_form_data[c.NP_COL_NTR_KORYSNA_MODEL_KILKIST] = ui_int_form(c.NP_COL_NTR_KORYSNA_MODEL_KILKIST,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ—Ä–∏—Å–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π", min_value=0, step=1)

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 11 & 12 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("¬©Ô∏è 11. –ê–≤—Ç–æ—Ä—Å—å–∫–µ –ø—Ä–∞–≤–æ")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_AVTORSKE_PRAVO_KILKIST] = ui_int_form(
                c.NP_COL_NTR_AVTORSKE_PRAVO_KILKIST,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–≤—ñ–¥–æ—Ü—Ç–≤", min_value=0, step=1)
        with col2:
            st.subheader("üìñ 12. –í–∏–¥–∞–Ω–Ω—è –æ–¥–Ω–æ–æ—Å—ñ–±–Ω–æ—ó –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—ó")
            st.markdown("---")
            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            mono_solo_type_options = [NEUTRAL_LABEL, "–≤ —ñ–Ω–æ–∑–µ–º–Ω–æ–º—É –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤—ñ", "–≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–º—É –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤—ñ"]
            cols_mono_s = st.columns([3, 1])
            new_mono_solo_type = cols_mono_s[0].selectbox("–¢–∏–ø –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤–∞", options=mono_solo_type_options,
                                                          key="np_new_mono_solo_type")
            new_mono_solo_sheets = cols_mono_s[1].number_input("–ö-—Å—Ç—å –∞–≤—Ç–æ—Ä—Å—å–∫–∏—Ö –∞—Ä–∫—É—à—ñ–≤", min_value=0.1,
                                                               step=0.1, format="%.1f",
                                                               key="np_new_mono_solo_sheets")
            if st.button("–î–æ–¥–∞—Ç–∏ –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—é", key="np_add_mono_solo"):
                if new_mono_solo_type != NEUTRAL_LABEL:
                    st.session_state.np_ntr_mono_solo_list.append(
                        {"type": new_mono_solo_type, "sheets": new_mono_solo_sheets})
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤–∞ –ø–µ—Ä—à –Ω—ñ–∂ –¥–æ–¥–∞–≤–∞—Ç–∏ –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—é.")
            if st.session_state.np_ntr_mono_solo_list:
                st.write("–î–æ–¥–∞–Ω—ñ –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—ó:")
                for i, mono in enumerate(st.session_state.np_ntr_mono_solo_list):
                    cols_mono_s_disp = st.columns([3, 1, 1])
                    cols_mono_s_disp[0].write(f"**–¢–∏–ø:** {mono['type']}")
                    cols_mono_s_disp[1].write(f"**–ê—Ä–∫—É—à—ñ–≤:** {mono['sheets']}")
                    if cols_mono_s_disp[2].button("üóëÔ∏è", key=f"np_del_mono_solo_{i}"):
                        st.session_state.np_ntr_mono_solo_list.pop(i)
                        st.rerun()

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 13 & 14 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üìö 13. –†–æ–∑–¥—ñ–ª —É –∫–æ–ª–µ–∫—Ç–∏–≤–Ω—ñ–π –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—ó")
            st.markdown("---")

            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            mono_team_type_options = [
                NEUTRAL_LABEL,
                "–≤ —ñ–Ω–æ–∑–µ–º–Ω–æ–º—É –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤—ñ",
                "–≤ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–º—É –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤—ñ",
            ]

            cols_mono_t = st.columns([2, 1, 1])

            new_mono_team_type = cols_mono_t[0].selectbox(
                "–¢–∏–ø –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤–∞", options=mono_team_type_options, index=0,
                key="np_new_mono_team_type",
            )

            new_mono_team_sheets = cols_mono_t[1].number_input(
                "–ö-—Å—Ç—å –∞–≤—Ç. –∞—Ä–∫—É—à—ñ–≤", min_value=0.1, step=0.1, format="%.1f",
                key="np_new_mono_team_sheets",
            )

            new_mono_team_authors = cols_mono_t[2].number_input(
                "–ö-—Å—Ç—å —Å–ø—ñ–≤–∞–≤—Ç–æ—Ä—ñ–≤", min_value=1, step=1,
                key="np_new_mono_team_authors",
            )

            if st.button("–î–æ–¥–∞—Ç–∏ —Ä–æ–∑–¥—ñ–ª", key="np_add_mono_team"):
                if new_mono_team_type != NEUTRAL_LABEL:
                    st.session_state.np_ntr_mono_team_list.append(
                        {
                            "type": new_mono_team_type,
                            "sheets": new_mono_team_sheets,
                            "authors": new_mono_team_authors,
                        }
                    )
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –≤–∏–¥–∞–≤–Ω–∏—Ü—Ç–≤–∞ –ø–µ—Ä—à –Ω—ñ–∂ –¥–æ–¥–∞–≤–∞—Ç–∏ —Ä–æ–∑–¥—ñ–ª.")

            if st.session_state.np_ntr_mono_team_list:
                st.write("–î–æ–¥–∞–Ω—ñ —Ä–æ–∑–¥—ñ–ª–∏:")
                for i, mono in enumerate(st.session_state.np_ntr_mono_team_list):
                    cols_mono_t_disp = st.columns([2, 1, 1, 1])
                    cols_mono_t_disp[0].write(f"**–¢–∏–ø:** {mono['type']}")
                    cols_mono_t_disp[1].write(f"**–ê—Ä–∫—É—à—ñ–≤:** {mono['sheets']}")
                    cols_mono_t_disp[2].write(f"**–°–ø—ñ–≤–∞–≤—Ç–æ—Ä—ñ–≤:** {mono['authors']}")
                    if cols_mono_t_disp[3].button("üóëÔ∏è", key=f"np_del_mono_team_{i}"):
                        st.session_state.np_ntr_mono_team_list.pop(i)
                        st.rerun()

        with col2:
            st.subheader("üîé 14. –†–µ—Ü–µ–Ω–∑—É–≤–∞–Ω–Ω—è –º–æ–Ω–æ–≥—Ä–∞—Ñ—ñ—ó / –ø—ñ–¥—Ä—É—á–Ω–∏–∫–∞")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_RECENZ_MONO_KILKIST] = ui_int_form(
                c.NP_COL_NTR_RECENZ_MONO_KILKIST,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ—Ü–µ–Ω–∑—ñ–π", min_value=0, step=1)

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 15 & 16 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üñãÔ∏è 15. –†–µ—Ü–µ–Ω–∑—É–≤–∞–Ω–Ω—è —Å—Ç–∞—Ç—Ç—ñ")
            st.markdown("---")
            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            review_type_options = [NEUTRAL_LABEL, "Scopus, WoS, —Ñ–∞—Ö–æ–≤–µ –≤–∏–¥–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ê",
                                   "—Ñ–∞—Ö–æ–≤–µ –≤–∏–¥–∞–Ω–Ω—è –£–∫—Ä–∞—ó–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ë",
                                   "–∑–∞–∫–æ—Ä–¥–æ–Ω–Ω–µ –≤–∏–¥–∞–Ω–Ω—è, —ñ–Ω–¥–µ–∫—Å–æ–≤–∞–Ω–µ –≤ —ñ–Ω—à–∏—Ö –±–∞–∑–∞—Ö"]

            cols_rev = st.columns([3, 1])
            new_review_type = cols_rev[0].selectbox("–¢–∏–ø –≤–∏–¥–∞–Ω–Ω—è", options=review_type_options,
                                                    key="np_new_review_type")
            new_review_count = cols_rev[1].number_input("–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1,
                                                        key="np_new_review_count")
            if st.button("–î–æ–¥–∞—Ç–∏ —Ä–µ—Ü–µ–Ω–∑—ñ—é", key="np_add_review"):
                if new_review_type != NEUTRAL_LABEL:
                    st.session_state.np_ntr_review_articles_list.append(
                        {"type": new_review_type, "count": new_review_count})
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –≤–∏–¥–∞–Ω–Ω—è –ø–µ—Ä—â –Ω—ñ–∂ –¥–æ–¥–∞—Ç–∏ —Ä–µ—Ü–µ–Ω–∑—ñ—é")
            if st.session_state.np_ntr_review_articles_list:
                st.write("–î–æ–¥–∞–Ω—ñ —Ä–µ—Ü–µ–Ω–∑—ñ—ó:")
                for i, review in enumerate(st.session_state.np_ntr_review_articles_list):
                    cols_rev_disp = st.columns([3, 1, 1])
                    cols_rev_disp[0].write(f"**–¢–∏–ø:** {review['type']}")
                    cols_rev_disp[1].write(f"**–ö-—Å—Ç—å:** {review['count']}")
                    if cols_rev_disp[2].button("üóëÔ∏è", key=f"np_del_review_{i}"):
                        st.session_state.np_ntr_review_articles_list.pop(i)
                        st.rerun()
        with col2:
            st.subheader("üë®‚Äçüè´ 16. –ö–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ –Ω–∞—É–∫–æ–≤–æ—é —Ä–æ–±–æ—Ç–æ—é –∫—É—Ä—Å–∞–Ω—Ç—ñ–≤")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_KERIVNYTSTVO_NDR_KURSANTIV_KILKIST] = ui_int_form(
                c.NP_COL_NTR_KERIVNYTSTVO_NDR_KURSANTIV_KILKIST,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ (—Å—Ç–∞—Ç—Ç—ñ, —Ç–µ–∑–∏, —Ä–æ–±–æ—Ç–∏ –Ω–∞ –∫–æ–Ω–∫—É—Ä—Å —Ç–æ—â–æ)", min_value=0, step=1)

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 17 & 18 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üèÜ 17. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –∫–æ–Ω–∫—É—Ä—Å—ñ–≤")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_PEREMOZH_VSEUKR_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_PEREMOZH_VSEUKR_KILKIST,
                "–ö-—Å—Ç—å –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –í—Å–µ—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å—É", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_PEREMOZH_VNUTRISH_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_PEREMOZH_VNUTRISH_KILKIST,
                "–ö-—Å—Ç—å –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å—É", min_value=0, step=1)
        with col2:
            st.subheader("üèÖ 18. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –æ–ª—ñ–º–ø—ñ–∞–¥")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_PEREMOZH_OLIMPIADA_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_PEREMOZH_OLIMPIADA_KILKIST,
                "–ö-—Å—Ç—å –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö/–í—Å–µ—É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –æ–ª—ñ–º–ø—ñ–∞–¥", min_value=0, step=1)

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 19 & 20 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("ü•á 19. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–º–∞–Ω–¥–∏-–ø–µ—Ä–µ–º–æ–∂–Ω–∏—Ü—ñ")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_KOMANDY_PEREMOZH_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_KOMANDY_PEREMOZH_KILKIST,
                "–ö-—Å—Ç—å –∫–æ–º–∞–Ω–¥-–ø–µ—Ä–µ–º–æ–∂–Ω–∏—Ü—å –∑–º–∞–≥–∞–Ω—å", min_value=0, step=1)
        with col2:
            st.subheader("üéñÔ∏è 20. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –æ–±–ª–∞—Å–Ω–∏—Ö –∫–æ–Ω–∫—É—Ä—Å—ñ–≤")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_PIDHOT_PEREMOZH_OBL_AKADEM_KILKIST] = ui_int_form(
                c.NP_COL_NTR_PIDHOT_PEREMOZH_OBL_AKADEM_KILKIST,
                "–ö-—Å—Ç—å –ø–µ—Ä–µ–º–æ–∂—Ü—ñ–≤ –æ–±–ª–∞—Å–Ω–æ–≥–æ, –∞–∫–∞–¥–µ–º—ñ—á–Ω–æ–≥–æ –∫–æ–Ω–∫—É—Ä—Å—É", min_value=0, step=1)

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 21 & 22 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üìî 21. –í–∏–¥–∞–≤–Ω–∏—á–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_PIDRUCHNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_VYDANNYA_PIDRUCHNYK_KILKIST,
                "–ü—ñ–¥—Ä—É—á–Ω–∏–∫–∏", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_PIDRUCHNYK_ID] = ui_text_form(
                c.NP_COL_NTR_VYDANNYA_PIDRUCHNYK_ID, "–ù–∞–∑–≤–∞ –ø—ñ–¥—Ä—É—á–Ω–∏–∫–∞"
            )
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_POSIBNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_VYDANNYA_POSIBNYK_KILKIST,
                "–ù–∞–≤—á–∞–ª—å–Ω—ñ –ø–æ—Å—ñ–±–Ω–∏–∫–∏", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_POSIBNYK_ID] = ui_text_form(
                c.NP_COL_NTR_VYDANNYA_POSIBNYK_ID, "–ù–∞–∑–≤–∞ –ø–æ—Å—ñ–±–Ω–∏–∫–∞"
            )
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_DOVIDNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_VYDANNYA_DOVIDNYK_KILKIST,
                "–î–æ–≤—ñ–¥–Ω–∏–∫–∏", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_DOVIDNYK_ID] = ui_text_form(
                c.NP_COL_NTR_VYDANNYA_DOVIDNYK_ID, "–ù–∞–∑–≤–∞ –¥–æ–≤—ñ–¥–Ω–∏–∫–∞"
            )
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_ZBIRNYK_KILKIST] = ui_int_form(
                c.NP_COL_NTR_VYDANNYA_ZBIRNYK_KILKIST, "–ó–±—ñ—Ä–Ω–∏–∫–∏", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_VYDANNYA_ZBIRNYK_ID] = ui_text_form(
                c.NP_COL_NTR_VYDANNYA_ZBIRNYK_ID, "–ù–∞–∑–≤–∞ –∑–±—ñ—Ä–Ω–∏–∫–∞"
            )
        with col2:
            st.subheader("üìà 22. –Ü–Ω–¥–µ–∫—Å –ì—ñ—Ä—à–∞ (Scopus/WoS)")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_HIRSCH_INDEX_VALUE] = ui_int_form(
                c.NP_COL_NTR_HIRSCH_INDEX_VALUE,
                "–ó–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É 'n'",
                min_value=0, step=1)

            # –ù–æ–≤–µ –ø–æ–ª–µ –¥–ª—è ID –ì—ñ—Ä—à–∞
            st.session_state.np_form_data[c.NP_COL_NTR_HIRSCH_PROFILE_ID] = ui_text_form(
                c.NP_COL_NTR_HIRSCH_PROFILE_ID, "ID –ø—Ä–æ—Ñ—ñ–ª—é (Scopus / WoS)")

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 23 & 24 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üó£Ô∏è 23. –°–ø—ñ–∫–µ—Ä –∑–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_SPIKER_KILKIST] = ui_int_form(
                c.NP_COL_NTR_SPIKER_KILKIST, "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Ö–æ–¥—ñ–≤",
                min_value=0, step=1)
        with col2:
            # --- –ë–ª–æ–∫ 24-25, –æ–∫—Ä–µ–º–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –æ–¥–∏–Ω ---
            st.subheader("üèõÔ∏è 24-25. –†–æ–±–æ—Ç–∞ –≤ —Ä–∞–¥–∞—Ö")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_NTR_RAZOVI_RADY_GOLOVA_KILKIST] = ui_int_form(
                c.NP_COL_NTR_RAZOVI_RADY_GOLOVA_KILKIST,
                "–†–∞–∑–æ–≤—ñ —Ä–∞–¥–∏ (–≥–æ–ª–æ–≤–∞)", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_RAZOVI_RADY_CHLEN_KILKIST] = ui_int_form(
                c.NP_COL_NTR_RAZOVI_RADY_CHLEN_KILKIST,
                "–†–∞–∑–æ–≤—ñ —Ä–∞–¥–∏ (—á–ª–µ–Ω)", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_SPEC_RADY_KAND_KILKIST] = ui_int_form(
                c.NP_COL_NTR_SPEC_RADY_KAND_KILKIST,
                "–°–ø–µ—Ü. —Ä–∞–¥–∏ (–∫–∞–Ω–¥.)", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_NTR_SPEC_RADY_DOCTOR_KILKIST] = ui_int_form(
                c.NP_COL_NTR_SPEC_RADY_DOCTOR_KILKIST,
                "–°–ø–µ—Ü. —Ä–∞–¥–∏ (–¥–æ–∫—Ç.)", min_value=0, step=1)


def render_np_or_form():
    with st.expander("–î–æ–¥–∞—Ç–æ–∫ 1.4: –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω–∞ –¥—ñ—è–ª—å–Ω—ñ—Å—Ç—å (–û–†)", expanded=False):

        # --- –ü–∞—Ä–∞ 1 & 2 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üß≠ 1. –í—ñ–π—Å—å–∫–æ–≤–æ-–ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_VIYSK_PROF_ORIENT_DNIV] = ui_int_form(c.NP_COL_OR_VIYSK_PROF_ORIENT_DNIV,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –¥–Ω—ñ–≤ –≤—ñ–¥—Ä—è–¥–∂–µ–Ω—å",
                min_value=0, step=1)
        with col2:
            st.subheader("ü§ù 2. –†–æ–±–æ—Ç–∞ –≤ –∫–æ–º—ñ—Å—ñ—è—Ö –ú–û–ù")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_KOMISII_MON_ZAHODIV] = ui_int_form(c.NP_COL_OR_KOMISII_MON_ZAHODIV,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Ö–æ–¥—ñ–≤",
                min_value=0, step=1)

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 3 & 4 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üìö 3. –î—ñ—è–ª—å–Ω—ñ—Å—Ç—å —É –Ω–∞—É–∫–æ–≤–æ-–º–µ—Ç–æ–¥–∏—á–Ω–∏—Ö —Ä–∞–¥–∞—Ö")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_DIYALNIST_RADY_VIKNU_ZASIDAN] = ui_int_form(
                c.NP_COL_OR_DIYALNIST_RADY_VIKNU_ZASIDAN,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Å—ñ–¥–∞–Ω—å (–Ω–µ –±—ñ–ª—å—à–µ 30 –±–∞–ª—ñ–≤)",
                min_value=0, step=1)
        with col2:
            st.subheader("üèõÔ∏è 4. –†–æ–±–æ—Ç–∞ —É —Å–∫–ª–∞–¥—ñ –≤—á–µ–Ω–æ—ó —Ä–∞–¥–∏")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_VCHENA_RADA_CHLEN_ZASIDAN] = ui_int_form(
                c.NP_COL_OR_VCHENA_RADA_CHLEN_ZASIDAN,
                "–ö-—Å—Ç—å –∑–∞—Å—ñ–¥–∞–Ω—å (—á–ª–µ–Ω —Ä–∞–¥–∏)",
                min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_OR_VCHENA_RADA_SEKRETAR_ZASIDAN] = ui_int_form(
                c.NP_COL_OR_VCHENA_RADA_SEKRETAR_ZASIDAN,
                "–ö-—Å—Ç—å –∑–∞—Å—ñ–¥–∞–Ω—å (—Å–µ–∫—Ä–µ—Ç–∞—Ä)",
                min_value=0, step=1)

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 5 & 6 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üìã 5. –†–æ–±–æ—Ç–∞ –≤ –µ–∫—Å–ø–µ—Ä—Ç–Ω–∏—Ö, –∫–æ–Ω–∫—É—Ä—Å–Ω–∏—Ö –∫–æ–º—ñ—Å—ñ—è—Ö")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_EKSPERT_KOMISII_ZASIDAN] = ui_int_form(
                c.NP_COL_OR_EKSPERT_KOMISII_ZASIDAN,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞—Å—ñ–¥–∞–Ω—å (–Ω–µ –±—ñ–ª—å—à–µ 30 –±–∞–ª—ñ–≤)",
                min_value=0, step=1)

        with col2:
            st.subheader("üåê 6. –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ–π")
            st.markdown("---")

            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            conf_role_options = [
                NEUTRAL_LABEL,
                "–≥–æ–ª–æ–≤–∞ –æ—Ä–≥–∫–æ–º—ñ—Ç–µ—Ç—É",
                "–≥–æ–ª–æ–≤–∞ —Å–µ–∫—Ü—ñ—ó",
                "—á–ª–µ–Ω –æ—Ä–≥–∫–æ–º—ñ—Ç–µ—Ç—É, —Å–µ–∫—Ä–µ—Ç–∞—Ä —Å–µ–∫—Ü—ñ—ó"
            ]

            cols = st.columns([3, 1])
            new_conf_role = cols[0].selectbox(
                "–†–æ–ª—å —É –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—ó", options=conf_role_options, index=0, key="np_new_conf_role"
            )
            new_conf_count = cols[1].number_input(
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1, key="np_new_conf_count"
            )

            if st.button("–î–æ–¥–∞—Ç–∏ —É—á–∞—Å—Ç—å —É –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—ó", key="np_add_conf"):
                if new_conf_role != NEUTRAL_LABEL:
                    st.session_state.np_or_conferences_list.append(
                        {"role": new_conf_role, "count": new_conf_count}
                    )
                    st.rerun()
                else:
                    st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–æ–ª—å –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º.")

            if st.session_state.np_or_conferences_list:
                st.write("–î–æ–¥–∞–Ω–∞ —É—á–∞—Å—Ç—å —É –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—è—Ö:")
                for i, conf in enumerate(st.session_state.np_or_conferences_list):
                    cols = st.columns([3, 1, 1])
                    cols[0].write(f"**–†–æ–ª—å:** {conf['role']}")
                    cols[1].write(f"**–ö-—Å—Ç—å:** {conf['count']}")
                    if cols[2].button("üóëÔ∏è", key=f"np_del_conf_{i}"):
                        st.session_state.np_or_conferences_list.pop(i)
                        st.rerun()

        st.markdown("---")
        # --- –ü–∞—Ä–∞ 7 & 8 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üèÜ 7. –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è —Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –æ–ª—ñ–º–ø—ñ–∞–¥")
            st.markdown("---")
            olymp_role_options = ["‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî",
                                  "–≤—Å–µ—É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö —Ç–∞ –º—ñ–∂–Ω–∞—Ä–æ–¥–Ω–∏—Ö",
                                  "–í—ñ–π—Å—å–∫–æ–≤–æ–≥–æ —ñ–Ω—Å—Ç–∏—Ç—É—Ç—É (—Ñ–∞–∫—É–ª—å—Ç–µ—Ç—É)",
                                  "–µ–∫—Å–ø–µ—Ä—Ç–∏ –∑ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è —Ä–æ–±—ñ—Ç"]

            cols = st.columns([3, 1])
            new_olymp_role = cols[0].selectbox("–†—ñ–≤–µ–Ω—å –æ–ª—ñ–º–ø—ñ–∞–¥–∏/–∫–æ–Ω–∫—É—Ä—Å—É", options=olymp_role_options,
                                               key="np_new_olymp_role",
                                               label_visibility="collapsed")
            new_olymp_count = cols[1].number_input("–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1, key="np_new_olymp_count",
                                                   label_visibility="collapsed")

            if st.button("–î–æ–¥–∞—Ç–∏ —É—á–∞—Å—Ç—å –≤ –æ–ª—ñ–º–ø—ñ–∞–¥—ñ", key="np_add_olymp"):
                if new_olymp_role != "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî":  # ‚úÖ –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø—É—Å—Ç–æ–≥–æ
                    st.session_state.np_or_olympiads_list.append(
                        {"role": new_olymp_role, "count": new_olymp_count})
                    st.rerun()
                else:
                    st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –æ–ª—ñ–º–ø—ñ–∞–¥–∏.")

            if st.session_state.np_or_olympiads_list:
                st.write("–î–æ–¥–∞–Ω–∞ —É—á–∞—Å—Ç—å –≤ –æ–ª—ñ–º–ø—ñ–∞–¥–∞—Ö/–∫–æ–Ω–∫—É—Ä—Å–∞—Ö:")
                for i, olymp in enumerate(st.session_state.np_or_olympiads_list):
                    cols = st.columns([3, 1, 1])
                    cols[0].write(f"**–†—ñ–≤–µ–Ω—å:** {olymp['role']}")
                    cols[1].write(f"**–ö-—Å—Ç—å:** {olymp['count']}")
                    if cols[2].button("üóëÔ∏è", key=f"np_del_olymp_{i}"):
                        st.session_state.np_or_olympiads_list.pop(i)
                        st.rerun()

        with col2:
            st.subheader("üñãÔ∏è 8. –†–æ–±–æ—Ç–∞ —É —Ä–µ–¥–∞–∫—Ü—ñ–π–Ω–∏—Ö –∫–æ–ª–µ–≥—ñ—è—Ö")
            st.markdown("---")
            NEUTRAL_LABEL = "‚Äî –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî"
            editorial_role_options = [
                NEUTRAL_LABEL,
                "–≤–∏–¥–∞–Ω–Ω—è—Ö, —â–æ —ñ–Ω–¥–µ–∫—Å—É—é—Ç—å—Å—è –≤ Scopus —Ç–∞ WoS",
                "–≤ –∑–∞–∫–æ—Ä–¥–æ–Ω–Ω–∏—Ö –≤–∏–¥–∞–Ω–Ω—è—Ö, —ñ–Ω–¥–µ–∫—Å–æ–≤–∞–Ω–∏—Ö –Ω–∞—É–∫–æ–º–µ—Ç—Ä–∏—á–Ω–∏–º–∏ –±–∞–∑–∞–º–∏",
                "—É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö —Ñ–∞—Ö–æ–≤–∏—Ö –≤–∏–¥–∞–Ω–Ω—è—Ö",
            ]

            cols = st.columns([3, 1])

            new_editorial_role = cols[0].selectbox(
                "–¢–∏–ø –≤–∏–¥–∞–Ω–Ω—è", options=editorial_role_options,
                index=0,  # –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                key="np_new_editorial_role", label_visibility="collapsed")

            new_editorial_count = cols[1].number_input(
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å", min_value=1, step=1, key="np_new_editorial_count", label_visibility="collapsed")

            if st.button("–î–æ–¥–∞—Ç–∏ —É—á–∞—Å—Ç—å —É —Ä–µ–¥–∫–æ–ª–µ–≥—ñ—ó", key="np_add_editorial"):
                if new_editorial_role != NEUTRAL_LABEL:
                    st.session_state.np_or_editorial_list.append(
                        {"role": new_editorial_role, "count": new_editorial_count}
                    )
                    st.rerun()
                else:
                    st.warning("–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –≤–∏–¥–∞–Ω–Ω—è –ø–µ—Ä—à –Ω—ñ–∂ –¥–æ–¥–∞–≤–∞—Ç–∏ –∑–∞–ø–∏—Å.")

            if st.session_state.np_or_editorial_list:
                st.write("–î–æ–¥–∞–Ω–∞ —É—á–∞—Å—Ç—å —É —Ä–µ–¥–∫–æ–ª–µ–≥—ñ—è—Ö:")
                for i, editorial in enumerate(st.session_state.np_or_editorial_list):
                    cols = st.columns([3, 1, 1])
                    cols[0].write(f"**–¢–∏–ø:** {editorial['role']}")
                    cols[1].write(f"**–ö-—Å—Ç—å:** {editorial['count']}")
                    if cols[2].button("üóëÔ∏è", key=f"np_del_editorial_{i}"):
                        st.session_state.np_or_editorial_list.pop(i)
                        st.rerun()

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 9 & 11 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üì∞ 9. –†–æ–±–æ—Ç–∞ –∑ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –Ω–∞—É–∫–æ–≤–∏—Ö –≤–∏–¥–∞–Ω—å")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_FORMUVANNYA_VISNYK_KILKIST] = ui_int_form(
                c.NP_COL_OR_FORMUVANNYA_VISNYK_KILKIST,
                "–í—ñ—Å–Ω–∏–∫ –ö–ù–£ (–∫-—Å—Ç—å –≤–∏–¥–∞–Ω—å)", min_value=0, step=1)
            st.session_state.np_form_data[c.NP_COL_OR_FORMUVANNYA_ZBIRNYK_VIKNU_KILKIST] = ui_int_form(
                c.NP_COL_OR_FORMUVANNYA_ZBIRNYK_VIKNU_KILKIST,
                "–ó–±—ñ—Ä–Ω–∏–∫ –ø—Ä–∞—Ü—å –í–Ü (–∫-—Å—Ç—å –≤–∏–¥–∞–Ω—å)", min_value=0, step=1)
        with col2:
            st.subheader("üìù 11. –í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å (–ø–æ–∑–∞ –ù–î–†)")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_OZ_INSHI_ARK_NPP] = ui_float_form(c.NP_COL_OR_OZ_INSHI_ARK_NPP,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–≤—Ç–æ—Ä—Å—å–∫–∏—Ö –∞—Ä–∫—É—à—ñ–≤", min_value=0.0, step=0.1)

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 12 & 13 ---
        col1, col2 = st.columns(2, border=True)
        with col1:
            st.subheader("üó£Ô∏è 12. –õ—ñ–Ω–≥–≤—ñ—Å—Ç–∏—á–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (—É—Å–Ω–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥)")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_LINGVO_USNYJ_DNIV] = ui_int_form(c.NP_COL_OR_LINGVO_USNYJ_DNIV,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤", min_value=0, step=1)
        with col2:
            st.subheader("‚úçÔ∏è 13. –õ—ñ–Ω–≥–≤—ñ—Å—Ç–∏—á–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è (–ø–∏—Å—å–º–æ–≤–∏–π –ø–µ—Ä–µ–∫–ª–∞–¥)")
            st.markdown("---")
            st.session_state.np_form_data[c.NP_COL_OR_LINGVO_PYSPOVYJ_STORINOK] = ui_int_form(
                c.NP_COL_OR_LINGVO_PYSPOVYJ_STORINOK,
                "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–µ—Ä–µ–∫–ª–∞–¥–∞—Ü—å–∫–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ (–ø–æ—Ä—Ü—ñ—ó –ø–æ 4)", min_value=0, step=1)

        st.markdown("---")

        # --- –ü–∞—Ä–∞ 14 & ---
        with st.container(border=True):
            st.subheader("üìà 14. –ü—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –∫–≤–∞–ª—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó")
            st.markdown("---")

            # === –ù–ê–ó–í–ò –ö–£–†–°–Ü–í ===
            st.caption("–î–æ–¥–∞–π—Ç–µ –Ω–∞–∑–≤–∏ –∫—É—Ä—Å—ñ–≤ (–Ω–µ –≤–ø–ª–∏–≤–∞—é—Ç—å –Ω–∞ –±–∞–ª–∏, –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–æ–≤—ñ–¥–∫–æ–≤–æ).")

            # —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–ø–∏—Å–∫—É —É session_state
            if "np_or_courses_list" not in st.session_state:
                st.session_state.np_or_courses_list = []

                # –ü–æ–ª—è –≤–≤–æ–¥—É (–Ω–∞–∑–≤–∞ + –∫—ñ–ª—å–∫—ñ—Å—Ç—å) –≤ –æ–¥–∏–Ω —Ä—è–¥–æ–∫
            col_course, col_count = st.columns([3, 1])
            with col_course:
                new_course = st.text_input("–ù–∞–∑–≤–∞ –∫—É—Ä—Å—É", key="or_course_title")
            with col_count:
                new_count = ui_int_form(
                    c.NP_COL_OR_PIDV_KVAL_KILKIST,
                    "–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤",
                    min_value=0,
                    step=1
                )
            st.session_state.np_form_data[c.NP_COL_OR_PIDV_KVAL_KILKIST] = new_count

            cols_btn = st.columns([1, 1, 3])
            if cols_btn[0].button("‚ûï –î–æ–¥–∞—Ç–∏ –∫—É—Ä—Å"):
                if new_course.strip():
                    st.session_state.np_or_courses_list.append({
                        "title": new_course.strip(),
                        "count": new_count
                    })
                    st.success("–ö—É—Ä—Å –¥–æ–¥–∞–Ω–æ.")
                else:
                    st.warning("–í–∫–∞–∂—ñ—Ç—å –Ω–∞–∑–≤—É –∫—É—Ä—Å—É.")

            if cols_btn[1].button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –∫—É—Ä—Å–∏"):
                st.session_state.np_or_courses_list = []
                st.info("–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω–æ.")

            # –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∫—É—Ä—Å–∏
            if st.session_state.np_or_courses_list:
                for i, item in enumerate(st.session_state.np_or_courses_list):
                    cc1, cc2, cc3 = st.columns([6, 2, 1])
                    cc1.write(f"üìò {item.get('title', '')}")
                    cc2.write(f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å: {item.get('count', 0)}")
                    if cc3.button("‚úñ", key=f"del_or_course_{i}"):
                        st.session_state.np_or_courses_list.pop(i)
                        st.rerun()
            else:
                st.info("–ö—É—Ä—Å–∏ —â–µ –Ω–µ –¥–æ–¥–∞–Ω—ñ.")


# --- –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ ---
def render_np_input_form_main():
    pib = st.session_state.current_np_pib
    if not pib:
        st.warning("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –Ω–∞—É–∫–æ–≤–æ–≥–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞.")
        return

    st.header(f"–í–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {pib}")

    # –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è
    display_scores_summary(pib)
    st.markdown("---")

    render_np_pp_form()
    render_np_ntr_form()
    render_np_or_form()

    st.markdown("---")

    # --- –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –î–ê–ù–ò–• –ó–ê –û–ë–†–ê–ù–ò–ô –†–Ü–ö ---
    if st.button("üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ –∑–∞ –æ–±—Ä–∞–Ω–∏–π —Ä—ñ–∫"):
        # 1) –°–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤—Å—ñ JSON-—Å–ø–∏—Å–∫–∏ —É —Ñ–æ—Ä–º—É
        st.session_state.np_form_data[c.NP_COL_NTR_STATTI_DETAILS_JSON] = json.dumps(
            st.session_state.np_ntr_articles_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_NTR_DOPOVIDI_DETAILS_JSON] = json.dumps(
            st.session_state.np_ntr_reports_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_NTR_MONO_ODNOOSIBNA_DETAILS_JSON] = json.dumps(
            st.session_state.np_ntr_mono_solo_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_NTR_MONO_KOLEKTYVNA_DETAILS_JSON] = json.dumps(
            st.session_state.np_ntr_mono_team_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_NTR_RECENZ_STATTI_DETAILS_JSON] = json.dumps(
            st.session_state.np_ntr_review_articles_list, ensure_ascii=False)

        st.session_state.np_form_data[c.NP_COL_OR_KONFERENTSII_DETAILS_JSON] = json.dumps(
            st.session_state.np_or_conferences_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_OR_OLIMPIADY_DETAILS_JSON] = json.dumps(
            st.session_state.np_or_olympiads_list, ensure_ascii=False)
        st.session_state.np_form_data[c.NP_COL_OR_REDKOLEGIYI_DETAILS_JSON] = json.dumps(
            st.session_state.np_or_editorial_list, ensure_ascii=False)

        # 2) –ó—ñ–±—Ä–∞—Ç–∏ form_row —ñ –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –ü–Ü–ë + –ü–µ—Ä—ñ–æ–¥
        form_row = dict(st.session_state.np_form_data)
        form_row[c.COL_PIB] = form_row.get(c.COL_PIB) or st.session_state.get("selected_pib", "")
        form_row[c.NP_COL_PERIOD] = form_row.get(c.NP_COL_PERIOD) or st.session_state.get("selected_period", "")

        if not form_row[c.COL_PIB] or not form_row[c.NP_COL_PERIOD]:
            st.error("–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ü–Ü–ë —ñ —Ä—ñ–∫ (–ø–µ—Ä—ñ–æ–¥).")
        else:
            # 3) –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–æ–≤—ñ –±–∞–ª–∏ –¥–ª—è —Ü—å–æ–≥–æ —Ä—è–¥–∫–∞
            #    (—Ä–æ–±–∏–º–æ —Ç–∏–º—á–∞—Å–æ–≤—É Series –ø–æ –≤—Å—ñ—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö, —â–æ–± –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–∞–≤ —É—Å–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–µ)
            tmp = pd.Series(form_row)
            tmp = tmp.reindex(st.session_state.np_ratings.columns, fill_value=0)
            updated = calc.calculate_all_scores_for_np(tmp)

            for col in [c.NP_COL_PP_TOTAL, c.NP_COL_NTR_TOTAL, c.NP_COL_OR_TOTAL, c.NP_COL_IB_TOTAL]:
                form_row[col] = updated.get(col, 0)

            # 4) Upsert –ø–æ (–ü–Ü–ë, –ü–µ—Ä—ñ–æ–¥)
            st.session_state.np_ratings = dm.upsert_np_row(st.session_state.np_ratings, form_row)

            # 5) –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª
            dm.save_np_ratings(st.session_state.np_ratings)

            st.success(f"–ó–±–µ—Ä–µ–∂–µ–Ω–æ: {form_row[c.COL_PIB]} ‚Äî {form_row[c.NP_COL_PERIOD]}")
            st.rerun()


# --- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è —Ç–∞ –ª–æ–≥—ñ–∫–∞ —Ä–æ–∑–¥—ñ–ª—ñ–≤ ---
# --- –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É ---
def login_screen():
    icon_uri = favicon_data_uri("favicon.ico")
    st.markdown(
        f"""<div style="display:flex;align-items:center;gap:18px;">
                <img src="{icon_uri}" width="50" height="50" />
                <span style="font-size:2.4rem;font-weight:700;color:black;">–°–∏—Å—Ç–µ–º–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è –ù–ü</span>
            </div>""",
        unsafe_allow_html=True
    )
    st.header("–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏")

    if st.session_state.np_structure.empty:
        st.error("–°–ø–∏—Å–æ–∫ –Ω–∞—É–∫–æ–≤–∏—Ö –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤ –ø–æ—Ä–æ–∂–Ω—ñ–π. –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return

    admin_pibs = set(ADMIN_USERS)
    ensure_login(st.session_state.np_structure, admin_pibs=admin_pibs)

    if st.session_state.get("logged_in_user"):
        st.success(f"–í—ñ—Ç–∞—î–º–æ, {st.session_state.logged_in_user}! –í–∏ —É—Å–ø—ñ—à–Ω–æ —É–≤—ñ–π—à–ª–∏.")
    else:
        left, _ = st.columns([6, 6])
        with left:
            st.markdown('<div id="login-google" class="uaf-login-button">', unsafe_allow_html=True)
            userinfo = _google_userinfo_via_button(button_label="üîê –£–≤—ñ–π—Ç–∏ –∑ Google")
            st.markdown('</div>', unsafe_allow_html=True)
        st.info("–£–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Google (–¥–æ–º–µ–Ω @knu.ua).")

    logout_button("–í–∏–π—Ç–∏")

    st.markdown('<div class="uaf-login-placeholder"></div>', unsafe_allow_html=True)


# --- –û—Å–Ω–æ–≤–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ ---
def main_app():
    icon_uri = favicon_data_uri("favicon.ico")
    st.sidebar.markdown(

        f"""<div style="display:flex;align-items:center;gap:8px;">
                <img src="{icon_uri}" width="30" height="30" />
                <span style="font-size:1.4rem;font-weight:700;color:white;">–ù–∞–≤—ñ–≥–∞—Ü—ñ—è</span>
            </div>
            """,
        unsafe_allow_html=True
    )
    ensure_login(st.session_state.np_structure)

    st.sidebar.success(f"–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫: **{st.session_state.logged_in_user}**")

    if st.session_state.is_admin:
        st.sidebar.warning("–í–∏ –≤ —Ä–µ–∂–∏–º—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")

    # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –æ–ø—Ü—ñ–π –º–µ–Ω—é
    if st.session_state.is_admin:
        menu_options = ["üè† –ì–æ–ª–æ–≤–Ω–∞", "üìù –í–≤–µ–¥–µ–Ω–Ω—è/–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö", "üìä –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ù–ü", "‚öôÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ù–ü"]
    else:
        menu_options = ["üè† –ì–æ–ª–æ–≤–Ω–∞", "üìù –í–≤–µ–¥–µ–Ω–Ω—è/–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö"]

    choice = st.sidebar.radio("–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∑–¥—ñ–ª:", menu_options)


    if st.sidebar.button("–í–∏–π—Ç–∏"):
        st.session_state.logged_in_user = None
        st.session_state.is_admin = False
        st.rerun()

    if choice == "üè† –ì–æ–ª–æ–≤–Ω–∞":
        st.title("–ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞")
        st.write(f"–í—ñ—Ç–∞—î–º–æ, {st.session_state.logged_in_user}!")
        st.info("–°–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ—Å—è –º–µ–Ω—é –ª—ñ–≤–æ—Ä—É—á –¥–ª—è –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó.")

    elif choice == "üìù –í–≤–µ–¥–µ–Ω–Ω—è/–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö":
        if st.session_state.is_admin:
            pib_list = sorted(st.session_state.np_structure[c.COL_PIB].tolist())
            selected_pib_index = pib_list.index(
                st.session_state.current_np_pib) if st.session_state.current_np_pib in pib_list else 0
            selected_pib = st.selectbox("–û–±–µ—Ä—ñ—Ç—å –ù–ü –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è (—Ä–µ–∂–∏–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞):", pib_list,
                                        index=selected_pib_index)
        else:
            selected_pib = st.session_state.logged_in_user

        # 2) –†—ñ–∫/–ø–µ—Ä—ñ–æ–¥ ‚Äî –õ–ò–®–ï —Ç—É—Ç
        period_options = [str(y) for y in range(2023, 2031)]
        current_period = st.session_state.get("selected_period")
        default_index = period_options.index(current_period) if current_period in period_options else len(
            period_options) - 1
        selected_period = st.selectbox("–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–∫ (–ø–µ—Ä—ñ–æ–¥) –¥–ª—è –≤–Ω–µ—Å–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö:", period_options,
                                       index=default_index)
        st.session_state.selected_period = selected_period

        if selected_pib != st.session_state.current_np_pib:
            get_current_np_data_row(selected_pib)
            st.rerun()

        if not st.session_state.np_form_data or st.session_state.np_form_data.get(c.COL_PIB) != selected_pib:
            get_current_np_data_row(selected_pib)

        # 4) –ì–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ —É —Ñ–æ—Ä–º—ñ —î –ü–Ü–ë —ñ –ü–µ—Ä—ñ–æ–¥
        st.session_state.np_form_data[c.COL_PIB] = selected_pib
        st.session_state.np_form_data[c.NP_COL_PERIOD] = selected_period

        render_np_input_form_main()

    elif choice == "üìä –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ù–ü" and st.session_state.is_admin:
        st.header("–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –ù–∞—É–∫–æ–≤–∏—Ö –ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤")

        # ==== –§—ñ–ª—å—Ç—Ä –ø–µ—Ä—ñ–æ–¥—ñ–≤ (—Ä–æ–∫—ñ–≤) –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É ====
        # 1) –í–∏—Ç—è–≥–∞—î–º–æ —Ä–æ–∫–∏ —è–∫ –ß–ò–°–õ–ê (–∫–æ–µ—Ä—Å–∏–º–æ –≤—Å–µ –∑–∞–π–≤–µ), –ø–æ—Ç—ñ–º —Ä–æ–±–∏–º–æ —Ä—è–¥–∫–∏

        df = st.session_state.np_ratings.copy()

        # –ö–æ–µ—Ä—Å–∏–º–æ –¥–æ —á–∏—Å–µ–ª —ñ —á–∏—Å—Ç–∏–º–æ —Å–º—ñ—Ç—Ç—è
        years_num = pd.to_numeric(df[c.NP_COL_PERIOD], errors="ignore")

        # –Ø–∫—â–æ –ø—ñ—Å–ª—è ignore –ª–∏—à–∏–ª–∏—Å—è —Ä—è–¥–∫–∏ ‚Äî –∫–æ–µ—Ä—Å–∏–º–æ —â–µ —Ä–∞–∑
        if years_num.dtype == "O":
            years_num = pd.to_numeric(df[c.NP_COL_PERIOD].astype(str).str.replace(",", ".").str.strip(),
                                      errors="coerce")

        # –§—ñ–ª—å—Ç—Ä –≤–∞–ª—ñ–¥–Ω–∏—Ö —Ä–æ–∫—ñ–≤: –±–µ–∑ NaN/0, —É —Ä–æ–∑—É–º–Ω–æ–º—É –¥—ñ–∞–ø–∞–∑–æ–Ω—ñ
        this_year = dt.datetime.now().year
        years_num = years_num.dropna()
        years_num = years_num.astype(float)

        valid_years = years_num[(years_num >= 2000) & (years_num <= this_year + 1)].astype(int)
        all_years = sorted(valid_years.unique())  # [2023, 2024, 2025]
        all_years_str = [str(y) for y in all_years]  # ['2023','2024','2025']

        # –Ø–∫—â–æ —Ä–∞–ø—Ç–æ–º –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î ‚Äî –Ω–µ –ø–∞–¥–∞—î–º–æ
        if not all_years_str:
            all_years_str = [str(this_year)]

        default_years = all_years_str[-3:] if len(all_years_str) >= 3 else all_years_str

        selected_years = st.multiselect(
            "–û–±–µ—Ä—ñ—Ç—å —Ä–æ–∫–∏ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É",
            options=all_years_str,
            default=default_years,
            key="ui_years_filter_general_rating",
        )

        if not selected_years:
            st.info("–†–æ–∫–∏ –Ω–µ –æ–±—Ä–∞–Ω–æ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ä—ñ–∫.")
            selected_years = [all_years_str[-1]]

        # –ü–µ—Ä–µ—Ä–∞—Ö—É—î–º–æ –±–∞–ª–∏, –∞ –ø–æ—Ç—ñ–º –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ –æ–±—Ä–∞–Ω–∏—Ö —Ä–æ–∫–∞—Ö
        full_ratings = st.session_state.np_ratings.copy()
        for i, row in full_ratings.iterrows():
            full_ratings.iloc[i] = calc.calculate_all_scores_for_np(row)

        full_ratings[c.NP_COL_PERIOD] = pd.to_numeric(full_ratings[c.NP_COL_PERIOD], errors="coerce").astype("Int64")
        full_ratings = full_ratings[full_ratings[c.NP_COL_PERIOD].isin(pd.Series(selected_years).astype(int))]
        full_ratings[c.NP_COL_PERIOD] = full_ratings[c.NP_COL_PERIOD].astype(str)

        # ==== –§—ñ–ª—å—Ç—Ä –ø–æ –ù–ü ====
        pib_list = sorted(full_ratings[c.COL_PIB].dropna().unique().tolist())
        selected_pibs = st.multiselect("–û–±–µ—Ä—ñ—Ç—å –ù–ü –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É", pib_list, default=pib_list[:5])

        filtered_ratings = full_ratings[full_ratings[c.COL_PIB].isin(selected_pibs)]

        # ==== –¢–∏–ø –≥—Ä–∞—Ñ—ñ–∫–∞ ====
        # chart_type = st.selectbox("–¢–∏–ø –≥—Ä–∞—Ñ—ñ–∫–∞", ["bar", "pie", "line"], index=0)
        chart_type = st.selectbox("–¢–∏–ø –≥—Ä–∞—Ñ—ñ–∫–∞", ["–≥—ñ—Å—Ç–æ–≥—Ä–∞–º–∞", "–∫—Ä—É–≥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞", "–ª—ñ–Ω—ñ–π–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞"], index=0)

        if chart_type == "–≥—ñ—Å—Ç–æ–≥—Ä–∞–º–∞":
            bar_chart = alt.Chart(filtered_ratings).transform_joinaggregate(
                mean_IB_total=f"mean({c.NP_COL_IB_TOTAL})"
            ).mark_bar(opacity=0.7).encode(
                x=alt.X(c.COL_PIB, sort='-y', axis=alt.Axis(labelAngle=-45)),
                y=alt.Y(c.NP_COL_IB_TOTAL, title="–ë–∞–ª–∏ (–Ü–ë = –ü–ü + –ù–¢–† + –û–†)"),
                color=alt.condition(
                    alt.datum[c.NP_COL_IB_TOTAL] > alt.datum.mean_IB_total,
                    alt.value("#FFD700"), alt.value("#808080")
                ),
                tooltip=[c.COL_PIB, alt.Tooltip(c.NP_COL_IB_TOTAL, format=".2f")]
            ).properties(height=400, width=800)
            st.altair_chart(bar_chart, use_container_width=True)

        elif chart_type == "–∫—Ä—É–≥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞":
            pie_df = pd.DataFrame({
                "–ö–∞—Ç–µ–≥–æ—Ä—ñ—è": ["–ü–ü", "–ù–¢–†", "–û–†"],
                "–ë–∞–ª–∏": [
                    filtered_ratings[c.NP_COL_PP_TOTAL].sum(),
                    filtered_ratings[c.NP_COL_NTR_TOTAL].sum(),
                    filtered_ratings[c.NP_COL_OR_TOTAL].sum()
                ]
            })
            pie_chart = alt.Chart(pie_df).mark_arc().encode(
                theta="–ë–∞–ª–∏:Q",
                color=alt.Color("–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:N", scale=alt.Scale(range=["#FFD700", "#3E3C36", "#228B22"])),
                tooltip=["–ö–∞—Ç–µ–≥–æ—Ä—ñ—è", "–ë–∞–ª–∏"]
            ).properties(title="–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤ –∑–∞ –±–ª–æ–∫–∞–º–∏")
            st.altair_chart(pie_chart, use_container_width=True)

        elif chart_type == "–ª—ñ–Ω—ñ–π–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞":
            if filtered_ratings.empty:
                st.warning("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –¥–∏–Ω–∞–º—ñ–∫–∏ –∑–∞ –æ–±—Ä–∞–Ω—ñ —Ä–æ–∫–∏/–ù–ü.")
            else:
                # –≥—Ä—É–ø—É—î–º–æ —Å–µ—Ä–µ–¥–Ω—ñ–π –Ü–ë –ø–æ —Ä–æ–∫–∞—Ö (–∑–∞ –ø–æ—Ç—Ä–µ–±–∏ –º–æ–∂–Ω–∞ —Ä–æ–±–∏—Ç–∏ –ø–æ –∫–æ–∂–Ω–æ–º—É –ü–Ü–ë –æ–∫—Ä–µ–º–æ)
                dyn = (
                    filtered_ratings
                    .groupby([c.NP_COL_PERIOD, c.COL_PIB], as_index=False)[c.NP_COL_IB_TOTAL]
                    .mean()
                    .sort_values([c.COL_PIB, c.NP_COL_PERIOD])
                )

                n_periods = dyn[c.NP_COL_PERIOD].nunique()
                if n_periods < 2:
                    st.info("–î–ª—è –ª—ñ–Ω—ñ–π –ø–æ –∫–æ–∂–Ω–æ–º—É –ù–ü –æ–±–µ—Ä—ñ—Ç—å —â–æ–Ω–∞–π–º–µ–Ω—à–µ –¥–≤–∞ —Ä–æ–∫–∏.")
                    chart = alt.Chart(dyn).mark_point(size=80).encode(
                        x=c.NP_COL_PERIOD, y=c.NP_COL_IB_TOTAL, color=c.COL_PIB,
                        tooltip=[c.COL_PIB, c.NP_COL_PERIOD, alt.Tooltip(c.NP_COL_IB_TOTAL, format=".2f")]
                    )
                else:
                    chart = alt.Chart(dyn).mark_line(strokeWidth=3).encode(
                        x=c.NP_COL_PERIOD, y=c.NP_COL_IB_TOTAL, color=c.COL_PIB,
                        tooltip=[c.COL_PIB, c.NP_COL_PERIOD, alt.Tooltip(c.NP_COL_IB_TOTAL, format=".2f")]
                    )
                st.altair_chart(chart.properties(height=300), use_container_width=True)

        st.markdown("---")
        # üîπ –ì–æ—Ç—É—î–º–æ –≤–µ—Ä—Å—ñ—é —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑—É/–µ–∫—Å–ø–æ—Ä—Ç—É
        df_view = with_pretty_headers(humanize_bools(filtered_ratings))

        # üìã –¢–∞–±–ª–∏—Ü—è –∑ –∫—Ä–∞—Å–∏–≤–∏–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —ñ ¬´–¢–∞–∫/–ù—ñ¬ª –∑–∞–º—ñ—Å—Ç—å True/False
        st.dataframe(df_view, use_container_width=True)

        # ‚¨áÔ∏è –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CSV —É —á–∏—Ç–∞–±–µ–ª—å–Ω–æ–º—É –≤–∏–≥–ª—è–¥—ñ
        csv_hr = df_view.to_csv(index=False, encoding="utf-8-sig")
        st.download_button(
            "‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV",
            csv_hr,
            "—Ä–µ–π—Ç–∏–Ω–≥_–Ω–∞—É–∫–æ–≤–∏—Ö_–ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤.csv",
            "text/csv"
        )


    elif choice == "‚öôÔ∏è –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ù–ü" and st.session_state.is_admin:
        st.header("–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å–ø–∏—Å–∫–æ–º –ù–∞—É–∫–æ–≤–∏—Ö –ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫—ñ–≤")
        with st.expander("‚ûï –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–æ–≥–æ –ù–ü"):
            new_pib = st.text_input("–ü–Ü–ë")
            new_pos = st.text_input("–ü–æ—Å–∞–¥–∞")
            if st.button("–î–æ–¥–∞—Ç–∏"):
                if new_pib and new_pos and new_pib not in st.session_state.np_structure[c.COL_PIB].values:
                    new_row = pd.DataFrame([{'–ü–Ü–ë': new_pib, '–ü–æ—Å–∞–¥–∞': new_pos}])
                    st.session_state.np_structure = pd.concat([st.session_state.np_structure, new_row], ignore_index=True)
                    dm.save_np_structure(st.session_state.np_structure)
                    st.session_state.np_ratings = dm.initialize_np_ratings_df(st.session_state.np_structure)
                    dm.save_np_ratings(st.session_state.np_ratings)
                    st.success(f"–î–æ–¥–∞–Ω–æ: {new_pib}")
                    st.rerun()
                else:
                    st.warning("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –∞–±–æ —Ç–∞–∫–∏–π –ü–Ü–ë –≤–∂–µ —ñ—Å–Ω—É—î.")

        st.dataframe(st.session_state.np_structure)

# --- –ì–æ–ª–æ–≤–Ω–∏–π —Ä–æ—É—Ç–µ—Ä –¥–æ–¥–∞—Ç–∫—É ---
if c.NP_COL_PERIOD not in st.session_state.np_ratings.columns:
    st.session_state.np_ratings[c.NP_COL_PERIOD] = str(datetime.now().year)
    dm.save_np_ratings(st.session_state.np_ratings)

if st.session_state.logged_in_user is None:
    login_screen()
else:
    main_app()
